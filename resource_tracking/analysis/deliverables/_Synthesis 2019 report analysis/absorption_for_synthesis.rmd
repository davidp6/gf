---
title: "Absorption Data Overview"
author: "Emily Linebarger"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: beamer_presentation

---
```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(data.table) 
library(ggplot2)
library(knitr)
library(kableExtra)
library(Hmisc)
library(glue)
library(memisc)
library(wesanderson)
library(gridExtra)
library(scales)
library(pander)
library(RColorBrewer)

options(scipen=15)

knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, fig.width=11, fig.height=8)
source("C:/Users/elineb/Documents/gf/resource_tracking/analysis/graphing_functions.r")
png_save = "J:/Project/Evaluation/GF/resource_tracking/visualizations/deliverables/Synthesis 2019/"

#Read in absorption data 
cod = readRDS("C:/Users/elineb/Box Sync/Global Fund Files/COD/prepped_data/absorption_cod.rds")
gtm = readRDS("C:/Users/elineb/Box Sync/Global Fund Files/GTM/prepped_data/absorption_gtm.rds")
sen = readRDS("C:/Users/elineb/Box Sync/Global Fund Files/SEN/prepped_data/absorption_sen.rds")
uga = readRDS("C:/Users/elineb/Box Sync/Global Fund Files/UGA/prepped_data/absorption_uga.rds")

all_absorption = rbindlist(list(cod, gtm, sen, uga))
all_absorption[, loc_name:=toupper(loc_name)]

#Fix disease names 
all_absorption[, grant_disease:=toupper(grant_disease)]
all_absorption[grant_disease=="MALARIA", grant_disease:="Malaria"]

#Add abbreviated module names. 
all_mods = readRDS("J:/Project/Evaluation/GF/resource_tracking/modular_framework_mapping/all_interventions.rds")
setnames(all_mods, c('module_eng', 'intervention_eng', 'abbrev_mod_eng', 'abbrev_int_eng'), c('gf_module', 'gf_intervention', 'abbrev_mod', 'abbrev_int'))
all_mods = all_mods[, .(gf_module, gf_intervention, disease, abbrev_mod, abbrev_int)]
all_absorption = merge(all_absorption, all_mods, by=c('gf_module', 'gf_intervention', 'disease'), allow.cartesian=TRUE)

#make sure this merge worked correctly. 
stopifnot(nrow(all_absorption[is.na(abbrev_int)])==0)

#Break out into smaller datasets. 
by_country = all_absorption[start_date>="2019-01-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('loc_name', 'grant_disease')]
by_country[, absorption:=(expenditure/budget)*100]
by_country[, label:=paste0(round(absorption, 1), "%")]
by_module = all_absorption[start_date>="2019-01-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('loc_name', 'grant', 'gf_module', 'abbrev_mod')]
by_module[, absorption:=(expenditure/budget)*100]
by_module[, label:=paste0(round(absorption, 1), "%")]
by_intervention = all_absorption[start_date>="2019-01-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('loc_name', 'grant', 'gf_module', 'gf_intervention', 'abbrev_mod', 'abbrev_int')]
by_intervention[, absorption:=(expenditure/budget)*100]
by_intervention[, label:=paste0(round(absorption, 1), "%")]

```

# Research questions 
Using 2019 PUDRs, we wanted to know: 

1. Are there any trends in the 2019 absorption so far?
2. Has absorption changed since the beginning of the grants? 
3. How does it compare to this semester in the 2015-2017 cycle? 
4. Are there specific findings for RSSH or key populations? 

# List of current grants 
```{r current_grants} 
kable_data = unique(all_absorption[grant_period%in%c('2016-2019', '2018-2020', '2019-2021', '2019-2022'), .(loc_name, grant_period, grant, grant_disease)])
gtm_grants = data.table(loc_name=rep("GTM", 2), grant_period=c('2019-2021', '2019-2022'), grant=c('GTM-M-MSPAS', 'GTM-T-MSPAS'), grant_disease=c('Malaria', 'TB'))
kable_data = rbind(kable_data, gtm_grants)
kable_data = kable_data[order(loc_name, grant_disease)]

kable(kable_data, col.names=c('Country', 'Grant Period', 'Grant', 'Disease'), align="l") %>%
  kable_styling(font_size=6)
```

DRC, Senegal, and Uganda are all on the same grant cycle, and their grants will span from 2018-2020. Guatemala is on a slightly different schedule, and their current grant period is 2016-2019. Guatemala also had several year-long grants in 2018, and they are starting new grants in 2019. 

# Reporting completeness 
```{r reporting}
reporting = fread("C:/Users/elineb/Box Sync/Global Fund Files/tableau_data/missing_pudr_coverage.csv")
#Only look at 2019 reporting 
reporting = reporting[date>=2019.0 & date<=2019.75]
reporting[grant=="GTM-H-INCAP" & missing_pudr_date<2019.50, missing_pudr_date:=NA] # I just haven't been able to re-run the expenditure data yet so this is wrong, but I do have this PUDR. 
reporting[, date:=factor(date, levels=c(2019.00, 2019.25, 2019.50, 2019.75), labels=c("Q1 2019", "Q2 2019", "Q3 2019", "Q4 2019"))]
reporting[, missing_pudr_date:=factor(missing_pudr_date, levels=c(2019.00, 2019.25, 2019.50, 2019.75), labels=c("Q1 2019", "Q2 2019", "Q3 2019", "Q4 2019"))]

ggplot(reporting) + 
  geom_point(aes(x=date, y=grant), shape=19) + 
  geom_point(aes(x=missing_pudr_date, y=grant), color="blue", size=6, alpha=0.5, shape=15) +
  theme_bw(base_size=18) + 
  labs(title=paste0("PUDR coverage for 2019"), subtitle="Black circles show expected grant quarters, \nand colored squares show missing data", x="Date", y="Grant")
```

# Research questions 
Using 2019 PUDRs, we wanted to know: 

1. __Are there any trends in the 2019 absorption so far?__
2. Has absorption changed since the beginning of the grants? 
3. How does it compare to this semester in the 2015-2017 cycle? 
4. Are there specific findings for RSSH or key populations? 

# Absorption overview by country for S1 2019
```{r slide1, results="asis"} 
ggplot(by_country, aes(x=loc_name, y=absorption, fill=grant_disease))+ 
  geom_bar(stat="identity", position="dodge") + 
  theme_bw(base_size=18) + 
  scale_fill_brewer(palette="Set2") + 
  scale_y_continuous(limits=c(0, 175)) + 
  geom_text(data=by_country, aes(x=loc_name, y=absorption, label=label), vjust=-0.5, position=position_dodge(width=1), size=4) + 
  labs(title="2019 absorption by country and disease", x="Country", y="Absorption (%)", fill="Disease", caption="*We have no PUDRs in Guatemala that started after Jan. 2019")

```

# Budget/Expenditure by country for S1 2019
```{r budget_exp_country}

 country_melt = by_country[, .(loc_name, grant_disease, budget, expenditure)]
  country_melt = melt(country_melt, id.vars=c('loc_name', 'grant_disease'), variable.name='variable', value.name='amount')
  country_melt[variable=="budget", label:=""] #Don't display the expenditure amount on the budget bar. 
  country_melt[variable=="expenditure", label:=dollar(amount)]
  
  #Fix budget and expenditure so they display nicely 
  country_melt[variable=="budget", variable:="Budget"]
  country_melt[variable=="expenditure", variable:="Expenditure"]
  
  ggplot(country_melt, aes(x=loc_name, y=amount, fill=variable))+ 
  geom_bar(stat="identity", position="identity") + 
  geom_text(aes(label=label), hjust=0, size=4) + 
  theme_bw(base_size=16) + 
  coord_flip() + 
  facet_wrap(~grant_disease)+
  theme(axis.text.x=element_text(angle=30, vjust=0.5)) + 
  scale_y_continuous(labels = scales::dollar) + 
  labs(title=paste0("Budget and expenditure for S1 2019"), x="Module", y="Amount ($)", fill="", 
       subtitle="Labels show expenditure amounts")
  
```

# Across grants, which modules have higher absorption than the PUDR average in 2019? 
This is based on the 14 PUDRs from DRC, Senegal, and Uganda.

```{r slide2, include=FALSE}
high_low_absorption = all_absorption[start_date>="2019-01-01", .(budget=sum(budget, na.rm=T), expenditure=sum(expenditure, na.rm=T)), by=c('grant', 'semester', 'grant_disease', 'abbrev_mod')]
high_low_absorption[, absorption:=round((expenditure/budget)*100, 1)]
high_low_absorption[absorption>200, absorption:=200]
high_low_absorption[is.na(absorption), absorption:=0] #This is only happening where budget and expenditure are 0. 
high_low_absorption[, mean_absorption:=(mean(expenditure, na.rm=T)/mean(budget, na.rm=T))*100,  by=c('grant', 'semester', 'grant_disease')]
high_low_absorption[absorption>=mean_absorption, absorption_rating:="ABOVE_AVERAGE"]
high_low_absorption[absorption<mean_absorption, absorption_rating:="BELOW_AVERAGE"]
```

# Absorption for HIV, HIV/TB grants (page 1/2)
```{r high_absorption_hiv}
kable(high_low_absorption[grant_disease%in%c('HIV', 'HIV/TB') & !is.na(absorption_rating), .N, by=c('abbrev_mod', 'absorption_rating')][order(abbrev_mod, absorption_rating)][1:20, ], col.names=c('Module', 'Absorption Rating', 'Grants'), align="l") %>%
  kable_styling(font_size=8)
```

# Absorption for HIV, HIV/TB grants (page 2/2)
```{r high_absorption_hiv2}
kable(high_low_absorption[grant_disease%in%c('HIV', 'HIV/TB') & !is.na(absorption_rating), .N, by=c('abbrev_mod', 'absorption_rating')][order(abbrev_mod, absorption_rating)][21:27, ], col.names=c('Module', 'Absorption Rating', 'Grants'), align="l") %>%
  kable_styling(font_size=8)
```

# Absorption for TB grants
```{r high_absorption_tb}
kable(high_low_absorption[grant_disease=="TB" & !is.na(absorption_rating), .N, by=c('abbrev_mod', 'absorption_rating')][order(abbrev_mod, absorption_rating)], col.names=c('Module', 'Absorption Rating', 'Grants'), align="l") %>%
  kable_styling(font_size=8)
```

# Absorption for malaria grants
```{r high_absorption_malaria}
kable(high_low_absorption[grant_disease=="Malaria" & !is.na(absorption_rating), .N, by=c('abbrev_mod', 'absorption_rating')][order(abbrev_mod, absorption_rating)], col.names=c('Module', 'Absorption Rating', 'Grants'), align="l") %>%
  kable_styling(font_size=8)
```

# How has RSSH performed overall for 2019 PUDRs? 
```{r rssh_high_low}
rssh_high_low = all_absorption[start_date>="2019-01-01", .(budget=sum(budget, na.rm=T), expenditure=sum(expenditure, na.rm=T)), by=c('grant', 'semester', 'grant_disease', 'disease', 'abbrev_mod')]
rssh_high_low[, absorption:=round((expenditure/budget)*100, 1)]
rssh_high_low[absorption>200, absorption:=200]
rssh_high_low[, mean_absorption:=(mean(expenditure, na.rm=T)/mean(budget, na.rm=T))*100,  by=c('grant', 'semester', 'grant_disease', 'disease')]
rssh_high_low[absorption>=mean_absorption, absorption_rating:="ABOVE_AVERAGE"]
rssh_high_low[absorption<mean_absorption, absorption_rating:="BELOW_AVERAGE"]
rssh_high_low = rssh_high_low[disease=="rssh"]
kable(rssh_high_low[!is.na(absorption_rating), .N, by=c('abbrev_mod', 'absorption_rating')][order(abbrev_mod, absorption_rating, -N)], col.names=c('Module', 'Absorption Rating', 'Grants'), align="l") %>%
  kable_styling(font_size=8)
```

12 of the 14 grants we have 2019 PUDRs for include RSSH.

```{r num_activities, include=FALSE} 
# Are there any correlations between the number of activities and absorption? 
#Merge absorption data with budget data to get activity and SR data. 
budgets = readRDS("C:/Users/elineb/Box Sync/Global Fund Files/tableau_data/final_budgets.rds")

activities_by_int = unique(budgets[, .(grant, grant_period, gf_module, gf_intervention, activity_description)])
activities_by_int[, count:=1]
activities_by_int = activities_by_int[, .(num_activities=sum(count)), by=c('grant', 'gf_module', 'gf_intervention')]
start_rows = nrow(activities_by_int)
activities_by_int = merge(activities_by_int, by_intervention, by=c('grant', 'gf_module', 'gf_intervention'), all=T) #Absorption is getting inflated here because you're merging on activities - 
stopifnot(nrow(activities_by_int)!=start_rows)

# Cap absorption to max 1000%. 
activities_by_int[absorption>1000, absorption:=1000]

# Pull unique observations - you should not recalculate absorption here! 
activities_by_int = unique(activities_by_int[, .(grant, abbrev_mod, abbrev_int, num_activities, loc_name, absorption)])

ggplot(activities_by_int[!is.na(abbrev_int)], aes(x=num_activities, y=absorption)) + 
  geom_point() + 
  theme_bw(base_size=16) + 
  labs(title="Absorption vs. Number of Activities for each Intervention", caption="*Dataset created from merged budgets and PUDRs\n*Absorption capped at 1000%", x="Number of activities", y="Absorption (%)")



```

```{r num_srs, include=FALSE}
# Is there a correlation between the number of SRs and absorption? 
srs_by_int = unique(budgets[grant_period=="2018-2020", .(grant, gf_module, gf_intervention, implementer)])
srs_by_int[, count:=1]
srs_by_int = srs_by_int[, .(num_implementers=sum(count)), by=c('grant', 'gf_module', 'gf_intervention')]
start_rows = nrow(srs_by_int)
srs_by_int = merge(srs_by_int, by_intervention, by=c('grant', 'gf_module', 'gf_intervention'), all=T) #Absorption is getting inflated here because you're merging on SRs - 
stopifnot(nrow(srs_by_int)!=start_rows)

# Cap absorption to max 1000%. 
srs_by_int[absorption>1000, absorption:=1000]

# Pull unique observations - you should not recalculate absorption here! 
srs_by_int = unique(srs_by_int[, .(grant, abbrev_mod, abbrev_int, num_implementers, loc_name, absorption)])

ggplot(srs_by_int, aes(x=num_implementers, y=absorption)) + 
  geom_point() + 
  theme_bw() + 
  labs(title="Absorption vs. Number of Implementers for each Intervention", caption="*Dataset created from merged budgets and PUDRs\n*Absorption capped at 1000%", x="Number of implementers", y="Absorption (%)")

```

```{r high_num_implementers, include=FALSE}
# Which interventions have more than 20 implementers? 
kable(srs_by_int[num_implementers>20, .(grant, abbrev_mod, abbrev_int, num_implementers, absorption)], col.names=c('Grant', 'Module', 'Intervention', '# Implementers', "Absorption")) %>%
  kable_styling(font_size=4)
```


```{r commodities, include=FALSE}
#In the SANRU grant in DRC, there are several interventions that have more than 20 implementers. 

# Does a highly-commoditized grant correspond with higher absorption? 

# EMILY START HERE. I THINK AN EASIER WAY TO DO THIS WOULD BE TO LOOK AT THE SUMMARY BUDGETS. 
#Try using keywords to tag commodities at the budget-level. 
commodity_words = c('arvs', 'llin', 'mosquitaire', 'genexpert', 'preservatif', 'condon', 'condom', ' xpert ', 'xpertmtb', 'tablets', 'artesunate', 'pruebas rapidas')
commodities = budgets[, .(budget=sum(budget)), by=c('loc_name', 'grant', 'disease', 'grant_period', 'gf_module', 'gf_intervention', 'code','activity_description')]
commodities[grepl(collapse(commodity_words, "|"), tolower(activity_description)), commodity:=TRUE]
commodities[is.na(commodity), commodity:=FALSE]

write.csv(unique(commodities[, .(activity_description, commodity)]), "C:/Users/elineb/Desktop/commodities.csv", row.names=F)
```


```{r absorption_regression, include=FALSE}
# What are the biggest predictors of high absorption? 
regression_data = by_intervention[, .(grant, gf_module, gf_intervention, absorption)]

srs_by_int = unique(budgets[grant_period=="2018-2020", .(grant, gf_module, gf_intervention, implementer)])
srs_by_int[, count:=1]
srs_by_int = srs_by_int[, .(num_implementers=sum(count)), by=c('grant', 'gf_module', 'gf_intervention')]

activities_by_int = unique(budgets[grant_period=="2018-2020", .(grant, gf_module, gf_intervention, activity_description)])
activities_by_int[, count:=1]
activities_by_int = activities_by_int[, .(num_activities=sum(count)), by=c('grant', 'gf_module', 'gf_intervention')]

#Merge all of this together 
regression_data = merge(regression_data, srs_by_int, by=c('grant', 'gf_module', 'gf_intervention'), all.x=T)
regression_data = merge(regression_data, activities_by_int, by=c('grant', 'gf_module', 'gf_intervention'), all.x=T)

#Flag commodity interventions
commodity_ints = c("Condom programming for MSM", "Condom programming for CSW", "Condom programming for IDU", "Condom programming for the general population", "Condom programming for transgender people", "Differentiated antiretroviral therapy service delivery", "Differentiated HIV testing services", "HIV testing adolescents and youth", "HIV testing CSW", "HIV testing for transgender people", "HIV testing IDU", "HIV testing MSM", "HIV testing other KVP", "LLIN: Continuous distribution", "LLIN: Mass campaign") #THESE SHOULD BE REVIEWED

regression_data = merge(regression_data, unique(all_mods), by=c('gf_module', 'gf_intervention'), all=T)
regression_data[abbrev_int%in%commodity_ints, commodity:=TRUE]
regression_data[is.na(commodity), commodity:=FALSE]

#Is the PR a government body or not? 
government = c('SEN-H-CNLS', 'SEN-M-PNLP', 'COD-M-MOH', 'UGA-M-MoFPED', 'COD-H-MOH', 'UGA-H-MoFPED', 'COD-T-MOH', 'SEN-Z-MOH', 'UGA-T-MoFPED')
community = c('COD-M-SANRU', 'UGA-M-TASO', 'UGA-C-TASO', 'SEN-H-ANCS', 'COD-C-CORDAID')

regression_data[grant%in%government, government_pr:=TRUE]
regression_data[grant%in%community, government_pr:=FALSE]
regression_data = regression_data[!is.na(grant)] #How are we even getting these?? 
stopifnot(nrow(regression_data[is.na(government_pr)])==0)

#Drop out NAs in absorption, and cap absorption to 1000%. 
regression_data = regression_data[!is.na(absorption)]
max_absorption = regression_data[!is.infinite(absorption), max(absorption)]
regression_data[is.infinite(absorption), absorption:=max_absorption]
```

```{r regression, echo=TRUE, include=FALSE}
model1 = lm(absorption ~ num_implementers + num_activities + commodity + government_pr, data=regression_data)
mtable1 = mtable('Model 1' = model1, summary.stats = c('R-squared','F','p','N'))
pander(mtable1)

```

# Finding statements for research question #1
* In all countries, tuberculosis grants reported the highest absorption numbers. They also have the lowest overall budgets. 
* For HIV and HIV/TB grants, absorption for PMTCT, sex workers, adolescents/youth and people who inject drugs were consistently below average, while program management and HMIS (RSSH) were consistently above average. 
* For TB grants, general care and prevention, TB/HIV, and program management are performing above vaerge, while HR & health workers (RSSH), HMIS (RSSH), and MDR-TB are performing below average. 
* For malaria grants, program management and national health strategies (RSSH) are performing above average, while HR & health workers (RSSH), community systems (RSSH), service delivery (RSSH), and vector control are performing below average. 
* Within RSSH modules, it's a mixed picture, except for community systems and service delivery, which have more grants below the average.
* Note that many grants (11 out of 14) have some money budgeted for info systems and M&E.

# Research questions 
Using 2019 PUDRs, we wanted to know: 

1. Are there any trends in the 2019 absorption so far?
2. __Has absorption changed since the beginning of the grants?__ 
3. How does it compare to this semester in the 2015-2017 cycle? 
4. Are there specific findings for RSSH or key populations?

# Have absorption rates increased since the start of the grant?
```{r compare_absorption, include=FALSE}
s1_2018 = all_absorption[start_date=="2018-01-01" & end_date=="2018-07-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('loc_name', 'grant_disease')]
s1_2018[, absorption:=(expenditure/budget)*100]
s1_2018[, label:=paste0(round(absorption, 1), "%")]
s1_2018[absorption>200, absorption:=200]

s1_2016 = all_absorption[start_date=="2016-01-01" & end_date=="2016-07-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('loc_name', 'grant_disease')]
s1_2016[, absorption:=(expenditure/budget)*100]
s1_2016[, label:=paste0(round(absorption, 1), "%")]
s1_2016[absorption>200, absorption:=200]

s2_2018 = all_absorption[grant_period=="2018-2020" & semester%in%c('Semester 1-2', 'Semester 2'), .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('loc_name', 'grant_disease')]
s2_2018[, absorption:=(expenditure/budget)*100]
s2_2018[, label:=paste0(round(absorption, 1), "%")]
s2_2018[absorption>200, absorption:=200]

p3 = ggplot(by_country, aes(x=loc_name, y=absorption, fill=grant_disease))+ 
  geom_bar(stat="identity", position="dodge") + 
  theme_bw(base_size=14) + 
  scale_fill_manual(values=wes_palette("GrandBudapest2")) + 
  scale_y_continuous(limits=c(0, 220)) + 
  geom_text(data=by_country, aes(x=loc_name, y=absorption, label=label), vjust=-0.5, position=position_dodge(width=1), size=4) + 
  theme(legend.position="none") + 
  labs(title="2019 S1 absorption", x="Country", y="Absorption (%)", fill="Disease")

p1 = ggplot(s1_2018, aes(x=loc_name, y=absorption, fill=grant_disease))+ 
  geom_bar(stat="identity", position="dodge") + 
  theme_bw(base_size=14) + 
  theme(legend.position=c(0.4, 0.7)) + 
  geom_text(data=s1_2018, aes(x=loc_name, y=absorption, label=label), vjust=-0.5, position=position_dodge(width=1), size=4) + 
  scale_fill_manual(values=wes_palette("GrandBudapest2")) + 
  scale_y_continuous(limits=c(0, 220)) + 
  labs(title="2018 S1 absorption", x="Country", y="Absorption (%)", fill="Disease")

p2 = ggplot(s2_2018, aes(x=loc_name, y=absorption, fill=grant_disease))+ 
  geom_bar(stat="identity", position="dodge") + 
  theme_bw(base_size=14) + 
  theme(legend.position="none") + 
  geom_text(data=s2_2018, aes(x=loc_name, y=absorption, label=label), vjust=-0.5, position=position_dodge(width=1), size=4) + 
  scale_fill_manual(values=wes_palette("GrandBudapest2")) + 
  scale_y_continuous(limits=c(0, 220)) + 
  labs(title="2018 S1-2 \nor S2 absorption", x="Country", y="Absorption (%)", fill="Disease")

#Just do P1 for right now because we have very few S1 2016 PUDRs. El 10/8/2019. 
grid.arrange(p1, p2, p3, ncol=3, nrow=1)
```

```{r compare_absorption1} 
comp_absorption = all_absorption[grant_period=="2018-2020", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('loc_name', 'grant_disease', 'semester')]
comp_absorption[, absorption:=(expenditure/budget)*100]
comp_absorption[, label:=paste0(round(absorption, 1), "%")]
comp_absorption[absorption>200, absorption:=200]
comp_absorption[, group:=paste0(loc_name, ", ", grant_disease)]

ggplot(comp_absorption, aes(x=semester, y=absorption, color=grant_disease, group=group, label=label))+ 
  geom_point() + 
  geom_line() + 
  theme_bw(base_size=14) + 
  facet_wrap(~loc_name) + 
  geom_text(vjust=-0.5, size=4, position=position_jitter()) + 
  theme(axis.text.x=element_text(angle=30, vjust=0.5)) + 
  scale_y_continuous(limits=c(0, 220)) + 
  labs(title="Trends in 2018-2020 absorption by disease and country", x="2018-2020 Semester", y="Absorption (%)", color="Disease", caption="*Absorption height limited to 200%")

```

```{r budget_exp_overtime, include=FALSE} 
comp_melt = comp_absorption[, .(loc_name, grant_disease, semester, budget, expenditure)]
  comp_melt = melt(comp_melt, id.vars=c('loc_name', 'grant_disease', 'semester'),variable.name='variable', value.name='amount')
  comp_melt[variable=="budget", label:=""] #Don't display the expenditure amount on the budget bar. 
  comp_melt[variable=="expenditure", label:=dollar(amount)]
  
  #Fix budget and expenditure so they display nicely 
  comp_melt[variable=="budget", variable:="Budget"]
  comp_melt[variable=="expenditure", variable:="Expenditure"]
  
  ggplot(comp_melt, aes(x=semester, y=amount, fill=variable))+ 
  geom_bar(stat="identity", position="identity") + 
  geom_text(aes(label=label), hjust=0, size=4) + 
  theme_bw(base_size=16) + 
  coord_flip() + 
    facet_wrap(~loc_name)+
  scale_y_continuous(labels = scales::dollar) + 
  labs(title=paste0("Budget and expenditure for S1 2019"), x="Module", y="Amount ($)", fill="", 
       subtitle="Labels show expenditure amounts")


```
# Finding statements for research question #2
* Absorption has steadily increased for DRC and Senegal since the beginning of the grant cycle. Absorption in Uganda has been more mixed, although the spike in Semester 1-2 may have been from catalytic funding. In Guatemala, we don't have enough data to draw a time trend.  

# Research questions 
Using 2019 PUDRs, we wanted to know: 

1. Are there any trends in the 2019 absorption so far?
2. Has absorption changed since the beginning of the grants?
3. __How does it compare to this semester in the 2015-2017 cycle?__
4. Are there specific findings for RSSH or key populations?


# Historical absorption, all countries pooled
```{r rq3_1} 
historical_avg = all_absorption[start_date!="2019-01-01", .(hist_budget=sum(budget, na.rm=T), hist_expenditure=sum(expenditure, na.rm=T)), by=c('abbrev_mod')]
historical_avg[, hist_absorption:=(hist_expenditure/hist_budget)*100]
historical_avg[hist_absorption>200, hist_absorption:=200]

only_2019 =all_absorption[start_date=="2019-01-01", .(budget=sum(budget, na.rm=T), expenditure=sum(expenditure, na.rm=T)), by=c('abbrev_mod')]
only_2019[, absorption:=(expenditure/budget)*100]
only_2019[absorption>200, absorption:=200]

compare_2019 = merge(historical_avg, only_2019, by=c('abbrev_mod'))
compare_2019[, diff:=absorption-hist_absorption]

ggplot(compare_2019[!is.na(diff)], aes(x=reorder(abbrev_mod, diff), y=diff, fill=diff)) + 
  geom_bar(stat="identity") + 
  theme_bw(base_size=16) + 
  coord_flip()+ 
  theme(legend.position="none") + 
  scale_fill_gradient2(low="red", high="green", midpoint=0, na.value="grey50") + 
  labs(title="2019 absorption, compared to historical average", x="Module", y="Difference between 2019 and historical absorption", 
       caption="*Historical absorption calculated from Jan 2015-Jan 2019")
```

# Historical absorption, by country 
```{r rq3} 
historical_avg = all_absorption[start_date!="2019-01-01", .(hist_budget=sum(budget, na.rm=T), hist_expenditure=sum(expenditure, na.rm=T)), by=c('abbrev_mod', 'loc_name')]
historical_avg[, hist_absorption:=(hist_expenditure/hist_budget)*100]
historical_avg[hist_absorption>200, hist_absorption:=200]

only_2019 =all_absorption[start_date=="2019-01-01", .(budget=sum(budget, na.rm=T), expenditure=sum(expenditure, na.rm=T)), by=c('abbrev_mod', 'loc_name')]
only_2019[, absorption:=(expenditure/budget)*100]
only_2019[absorption>200, absorption:=200]

compare_2019 = merge(historical_avg, only_2019, by=c('abbrev_mod', 'loc_name'))
compare_2019[, diff:=absorption-hist_absorption]

ggplot(compare_2019, aes(x=reorder(abbrev_mod, diff), y=diff, fill=diff)) + 
  geom_bar(stat="identity") + 
  theme_bw(base_size=16) + 
  coord_flip()+ 
  facet_wrap(~loc_name) +
  theme(legend.position="none") + 
  scale_fill_gradient2(low="red", high="green", midpoint=0, na.value="grey50") + 
  labs(title="2019 absorption, compared to historical average", x="Module", y="Difference between 2019 and historical absorption", 
       caption="*Historical absorption calculated since 2015")
```

# Finding statements for research question #3
* National health strategies (RSSH), TB/HIV, and financial systems (RSSH) have performed better in S1 2019 than the average from January 2015-January 2019, but this has mainly been driven by improvements in a single country (Uganda, DRC, and Uganda, respectively). 
* HIV prevention modules are generally performing worse in 2019 than the historical average, specifically programs for the general population, other KVP, CSW, IJU, and MSM. 
* Vector control and HIV testing are also performing more poorly, but this is mainly due to trends in Uganda. 

# Research questions 
Using 2019 PUDRs, we wanted to know: 

1. Are there any trends in the 2019 absorption so far?
2. Has absorption changed since the beginning of the grants? 
3. How does it compare to this semester in the 2015-2017 cycle? 
4. __Are there specific findings for RSSH or key populations?__

# Within RSSH modules, which have the highest absorption?
```{r slide4, results="asis"}
rssh_mods = c('Health management information system and monitoring and evaluation', "Human resources for health, including community health workers", 
              "Community responses and systems", "National health strategies", "Integrated service delivery and quality improvement", 
              "Procurement and supply chain management systems")

plot_data = all_absorption[gf_module%in%rssh_mods & grant_period=="2018-2020" & start_date=="2019-01-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('abbrev_mod')] #Collapse across grants
plot_data[, absorption:=round((expenditure/budget)*100, 1)]
plot_data[, label1:=paste0(absorption, "%")]
plot_data[absorption>200, absorption:=200]

ggplot(plot_data, aes(x=abbrev_mod, y=absorption)) + 
  geom_bar(stat="identity", fill="coral1") + 
  theme_bw(base_size=18) + 
  geom_text(aes(label=label1), hjust=0, size=4) +
  coord_flip() + 
  scale_fill_manual(values=wes_palette("Zissou1")) + 
  labs(title="Absorption for RSSH modules for S1 2019", x="Module", y="Absorption (%)", fill="Semester", subtitle="Pooled across all grants", caption="*Bar height capped at 200%")
```

# Budget/Expenditure for RSSH modules 
```{r budget_exp_rssh}

  rssh_melt = plot_data[, .(abbrev_mod, budget, expenditure)]
  rssh_melt = melt(rssh_melt, id.vars=c('abbrev_mod'), variable.name='variable', value.name='amount')
  rssh_melt[variable=="budget", label:=""] #Don't display the expenditure amount on the budget bar. 
  rssh_melt[variable=="expenditure", label:=dollar(amount)]
  
  #Fix budget and expenditure so they display nicely 
  rssh_melt[variable=="budget", variable:="Budget"]
  rssh_melt[variable=="expenditure", variable:="Expenditure"] 
  
  ggplot(rssh_melt, aes(x=abbrev_mod, y=amount, fill=variable))+ 
  geom_bar(stat="identity", position="identity") + 
  geom_text(aes(label=label), hjust=0, size=4) + 
  theme_bw(base_size=16) + 
  coord_flip() + 
  scale_y_continuous(labels = scales::dollar) + 
  labs(title=paste0("RSSH budget and expenditure"), x="Module", y="Amount ($)", fill="", 
       subtitle="Labels show expenditure amounts")



```

# HMIS absorption 
```{r hmis} 
plot_data = all_absorption[gf_module=='Health management information system and monitoring and evaluation' & grant_period=="2018-2020" & start_date=="2019-01-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('abbrev_int')] #Collapse across grants
plot_data[, absorption:=round((expenditure/budget)*100, 1)]
plot_data[, label1:=paste0(absorption, "%")]
plot_data[absorption>200, absorption:=200]

ggplot(plot_data, aes(x=abbrev_int, y=absorption)) + 
  geom_bar(stat="identity", fill="darkgreen") + 
  theme_bw(base_size=18) + 
  geom_text(aes(label=label1), hjust=0, size=4) +
  coord_flip() + 
  scale_fill_manual(values=wes_palette("Zissou1")) + 
  labs(title="Absorption for HMIS interventions for S1 2019", x="Intervention", y="Absorption (%)", fill="Semester", subtitle="Pooled across all grants", caption="*Bar height capped at 200%")
```

# HMIS budget and expenditure
```{r hmis_budget}
  hmis_melt = plot_data[, .(abbrev_int, budget, expenditure)]
  hmis_melt = melt(hmis_melt, id.vars=c('abbrev_int'), variable.name='variable', value.name='amount')
  hmis_melt[variable=="budget", label:=""] #Don't display the expenditure amount on the budget bar. 
  hmis_melt[variable=="expenditure", label:=dollar(amount)]
  
  #Fix budget and expenditure so they display nicely 
  hmis_melt[variable=="budget", variable:="Budget"]
  hmis_melt[variable=="expenditure", variable:="Expenditure"] 
  
  ggplot(hmis_melt, aes(x=abbrev_int, y=amount, fill=variable))+ 
  geom_bar(stat="identity", position="identity") + 
  geom_text(aes(label=label), hjust=0, size=4) + 
  theme_bw(base_size=16) + 
  coord_flip() + 
  scale_y_continuous(labels = scales::dollar) + 
  labs(title=paste0("HMIS budget and expenditure"), x="Intervention", y="Amount ($)", fill="", 
       subtitle="Labels show expenditure amounts")
```

# Finding statements for research question #4 (RSSH)
* For RSSH, the modules that have the lowest overall budget are reporting the best absorption numbers. 
* Many of the biggest RSSH  modules are still reporting absorption at or below 60% (HMIS, human resources and health workers, service delivery)
* Community systems is an outlier, because even though it has a small budget it's reporting low absorption numbers. 
* The main module to watch here is HMIS - it has the highest overall budget, and 11 of the 14 grants represented in this graph included it in their budgets. 
* There has been a significant HMIS investment in "program and data quality" and "analysis, review and transparency".  

# Are there trends in absorption for HIV key populations? 

```{r key_populations_hiv, results="asis"}
# Look at KP absorption for all HIV and HIV/TB grants. 

kp_mods = c("Comprehensive prevention programs for men who have sex with men", "Comprehensive prevention programs for people who inject drugs and their partners", "Comprehensive prevention programs for sex workers and their clients", "Comprehensive prevention programs for transgender people", "Prevention programs for adolescents and youth, in and out of school", "Prevention programs for other vulnerable populations")

hiv_kp_data = all_absorption[gf_module%in%kp_mods & start_date=="2019-01-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('abbrev_mod', 'gf_module')]
hiv_kp_data[, absorption:=round((expenditure/budget)*100, 1)]
hiv_kp_data[, label:=paste0(absorption, "%")]

hiv_kp_data[, key_population:=gsub("Comprehensive prevention programs for |Prevention programs for ", "", gf_module)]
hiv_kp_data[, key_population:=capitalize(key_population)]
hiv_kp_data[key_population=="People who inject drugs and their partners", key_population:="People who inject drugs"]
hiv_kp_data[key_population=="Adolescents and youth, in and out of school", key_population:="Adolescents and youth"]

ggplot(hiv_kp_data, aes(x=key_population, y=absorption)) + 
  geom_bar(stat="identity", fill="darkslategray2") + 
  theme_bw(base_size=18) + 
  geom_text(aes(label=label), hjust=0, size=4) +
  coord_flip() + 
  scale_fill_manual(values=wes_palette("Zissou1")) + 
  labs(title="Absorption for HIV KP modules in S1 2019", subtitle="Pooled across all grants", x="Module", y="Absorption") 
```

# Budget/Expenditure for key populations

```{r budget_exp_kp_hiv} 

 kp_melt = hiv_kp_data[, .(key_population, budget, expenditure)]
  kp_melt = melt(kp_melt, id.vars=c('key_population'), variable.name='variable', value.name='amount')
  kp_melt[variable=="budget", label:=""] #Don't display the expenditure amount on the budget bar. 
  kp_melt[variable=="expenditure", label:=dollar(amount)]
  
  #Fix budget and expenditure so they display nicely 
  kp_melt[variable=="budget", variable:="Budget"]
  kp_melt[variable=="expenditure", variable:="Expenditure"] 
  
  ggplot(kp_melt, aes(x=key_population, y=amount, fill=variable))+ 
  geom_bar(stat="identity", position="identity") + 
  geom_text(aes(label=label), hjust=0, size=4) + 
  theme_bw(base_size=16) + 
  coord_flip() + 
  scale_y_continuous(labels = scales::dollar) + 
  labs(title=paste0("Budget and expenditure for HIV key populations"), x="Module", y="Amount ($)", fill="", 
       subtitle="Labels show expenditure amounts")

# How many grants have budget recorded for key populations? 
```

# Absorption for TB key populations 

```{r key_populations_tb, results="asis"}
# Look at KP absorption for all HIV and HIV/TB grants. 
kp_ints = unique(all_absorption$gf_intervention[grep("key populations", tolower(all_absorption$gf_intervention))])

tb_kp_data = all_absorption[gf_intervention%in%kp_ints & start_date=="2019-01-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('abbrev_int', 'abbrev_mod')]
tb_kp_data[, absorption:=round((expenditure/budget)*100, 1)]
tb_kp_data[, label:=paste0(absorption, "%")]

tb_kp_data[, key_population:=paste0(abbrev_mod, ": ", abbrev_int)]
tb_kp_data[, kep_population:=gsub("Key populations - ", "", key_population)]

ggplot(tb_kp_data, aes(x=key_population, y=absorption)) + 
  geom_bar(stat="identity", fill="darkslategray2") + 
  theme_bw(base_size=18) + 
  geom_text(aes(label=label), hjust=0, size=4) +
  coord_flip() + 
  scale_fill_manual(values=wes_palette("Zissou1")) + 
  labs(title="Absorption for TB KP modules in S1 2019", subtitle="Pooled across all grants", x="Module", y="Absorption") 
```

# Budget/Expenditure for key populations

```{r budget_exp_kp_tb} 

 kp_melt = tb_kp_data[, .(key_population, budget, expenditure)]
  kp_melt = melt(kp_melt, id.vars=c('key_population'), variable.name='variable', value.name='amount')
  kp_melt[variable=="budget", label:=""] #Don't display the expenditure amount on the budget bar. 
  kp_melt[variable=="expenditure", label:=dollar(amount)]
  
  #Fix budget and expenditure so they display nicely 
  kp_melt[variable=="budget", variable:="Budget"]
  kp_melt[variable=="expenditure", variable:="Expenditure"] 
  
  ggplot(kp_melt, aes(x=key_population, y=amount, fill=variable))+ 
  geom_bar(stat="identity", position="identity") + 
  geom_text(aes(label=label), hjust=0, size=4) + 
  theme_bw(base_size=16) + 
  coord_flip() + 
  scale_y_continuous(labels = scales::dollar) + 
  labs(title=paste0("Budget and expenditure for tb key populations"), x="Module", y="Amount ($)", fill="", 
       subtitle="Labels show expenditure amounts")

# How many grants have budget recorded for key populations? 
```


```{r budget_to_absorption, include=FALSE} 
# Does a higher budget always correlate with lower absorption? 
budget_v_absorption = all_absorption[grant_period=="2018-2020", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('grant', 'abbrev_mod', 'semester', 'loc_name')]
budget_v_absorption[, absorption:=round((expenditure/budget)*100, 1)]

ggplot(budget_v_absorption, aes(x=budget, y=absorption, color=loc_name)) + 
  geom_point() + 
  theme_bw(base_size=16) + 
  scale_x_continuous(label=scales::dollar) + 
  labs(title="Budget versus absorption percentage", subtitle="*Each dot represents a module for a given semester and grant", x="Budget", y="Absorption (%)", color="Country")

```

# Are there differences in absorption for KPs by type of PR? 
```{r kp_by_sr}

#Tag governmental and non-governmental PRs. 
all_absorption[grant%in%c('COD-C-CORDAID', 'SEN-H-ANCS', 'UGA-C-TASO', 'GTM-H-INCAP'), pr_type:='Civil Society']
all_absorption[grant%in%c('COD-H-MOH', 'SEN-H-CNLS', 'UGA-H-MoFPED'), pr_type:='Governmental']

hiv_kp_data2 = all_absorption[gf_module%in%kp_mods & start_date=="2019-01-01", .(budget=sum(budget, na.rm=TRUE), expenditure=sum(expenditure, na.rm=TRUE)), by=c('abbrev_mod', 'gf_module', 'pr_type')]
hiv_kp_data2[, absorption:=round((expenditure/budget)*100, 1)]
hiv_kp_data2[, label:=paste0(absorption, "%")]

hiv_kp_data2[, key_population:=gsub("Comprehensive prevention programs for |Prevention programs for ", "", gf_module)]
hiv_kp_data2[, key_population:=capitalize(key_population)]
hiv_kp_data2[key_population=="People who inject drugs and their partners", key_population:="People who inject drugs"]
hiv_kp_data2[key_population=="Adolescents and youth, in and out of school", key_population:="Adolescents and youth"]

ggplot(hiv_kp_data2, aes(x=key_population, y=absorption)) + 
  geom_bar(stat="identity", fill="darkorange3") + 
  theme_bw(base_size=18) + 
  geom_text(aes(label=label), hjust=0, size=4) +
  coord_flip() + 
  facet_wrap(~pr_type) + 
  scale_fill_manual(values=wes_palette("Zissou1")) + 
  labs(title="Absorption for HIV KP modules in S1 2019", subtitle="Faceted by PR type", x="Module", y="Absorption") 
```

# Finding statements for research question #4 (key populations)
* Again, the modules that have the lowest overall budget are reporting the best absorption numbers, specifically for transgender people and people who inject drugs under HIV and other key populations under TB.
* Non-governmental PRs are reporting better absorption numbers in S1 2019 than governmental PRs. 

# Additional analyses using financial data 
* Sustainability, transition, and co-financing

# DRC HIV
```{r cod_stc_hiv} 
funding_landscape("proportion", "cod", "hiv", 2010, 2017, includeGHE=TRUE)
```

# DRC TB
```{r cod_stc_tb} 
funding_landscape("proportion", "cod", "tb", 2010, 2017, includeGHE=TRUE)
```

# DRC malaria
```{r cod_stc_mal} 
funding_landscape("proportion", "cod", "malaria", 2010, 2017, includeGHE=TRUE)
```

# Guatemala HIV
```{r gtm_stc_hiv} 
funding_landscape("proportion", "gtm", "hiv", 2010, 2017, includeGHE=TRUE)
```

# Guatemala TB
```{r gtm_stc_tb} 
funding_landscape("proportion", "gtm", "tb", 2010, 2017, includeGHE=TRUE)
```

# Guatemala malaria
```{r gtm_stc_mal} 
funding_landscape("proportion", "gtm", "malaria", 2010, 2017, includeGHE=TRUE)
```

# Senegal HIV
```{r sen_stc_hiv} 
funding_landscape("proportion", "sen", "hiv", 2010, 2017, includeGHE=TRUE)
```

# Senegal TB
```{r sen_stc_tb} 
funding_landscape("proportion", "sen", "tb", 2010, 2017, includeGHE=TRUE)
```

# Senegal malaria
```{r sen_stc_mal} 
funding_landscape("proportion", "sen", "malaria", 2010, 2017, includeGHE=TRUE)
```

# Uganda HIV
```{r uga_stc_hiv} 
funding_landscape("proportion", "uga", "hiv", 2010, 2017, includeGHE=TRUE)
```

# Uganda TB
```{r uga_stc_tb} 
funding_landscape("proportion", "uga", "tb", 2010, 2017, includeGHE=TRUE)
```

# Uganda malaria
```{r uga_stc_mal} 
funding_landscape("proportion", "uga", "malaria", 2010, 2017, includeGHE=TRUE)
```


